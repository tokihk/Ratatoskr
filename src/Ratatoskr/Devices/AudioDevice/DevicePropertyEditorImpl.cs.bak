using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Drawing;
using System.Data;
using System.IO.Ports;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using NAudio.CoreAudioApi;
using NAudio.Wave;

namespace Ratatoskr.Devices.AudioDevice
{
    internal partial class DevicePropertyEditorImpl : DevicePropertyEditor
    {
        private class InputDeviceListItem
        {
            public InputDeviceListItem(WaveInCapabilities value)
            {
                Value = value;
            }

            public WaveInCapabilities Value { get; }

            public override int GetHashCode()
            {
                return (base.GetHashCode());
            }

            public override bool Equals(object obj)
            {
                if (obj is string) {
                    return (Value.NameGuid.ToString() == (obj as string));
                } else {
                    return (base.Equals(obj));
                }
            }

            public override string ToString()
            {
                return (Value.ProductName);
            }
        }

        private class OutputDeviceListItem
        {
            public OutputDeviceListItem(MMDevice dev)
            {
                Value = dev;
            }

            public MMDevice Value { get; }

            public override int GetHashCode()
            {
                return (base.GetHashCode());
            }

            public override bool Equals(object obj)
            {
                if (obj.GetType() == typeof(string)) {
                    return (Value.ID == (obj as string));
                } else {
                    return (base.Equals(obj));
                }
            }

            public override string ToString()
            {
                return (Value.FriendlyName);
            }
        }

        private DevicePropertyImpl devp_;


        public DevicePropertyEditorImpl() : base()
        {
            InitializeComponent();
        }

        public DevicePropertyEditorImpl(DevicePropertyImpl devp) : this()
        {
            devp_ = devp as DevicePropertyImpl;

            InitializeInputDeviceList();
            InitializeInputSamplingRate();
            InitializeInputBitsPerSample();
            InitializeInputChannelNum();
            InitializeOutputDeviceList();

            ChkBox_InputEnable.Checked = devp.InputEnable.Value;
            CBox_InputDeviceList.SelectedItem = devp.InputDeviceId.Value;
            CBox_InputSamplingRate.SelectedItem = (uint)devp.InputSamplingRate.Value;
            CBox_InputBitsPerSample.SelectedItem = (uint)devp.InputBitsPerSample.Value;
            CBox_InputChannelNum.SelectedItem = devp.InputChannelNum.Value;

            ChkBox_OutputEnable.Checked = devp.OutputEnable.Value;
            CBox_OutputDeviceList.SelectedItem = devp.OutputDeviceId.Value;
        }

        private void InitializeInputDeviceList()
        {
            var dev_count = WaveIn.DeviceCount;

            CBox_InputDeviceList.BeginUpdate();
            {
                for (var dev_no = 0; dev_no < dev_count; dev_no++) {
                    CBox_InputDeviceList.Items.Add(new InputDeviceListItem(WaveIn.GetCapabilities(dev_no)));
                }
                if (CBox_InputDeviceList.Items.Count > 0) {
                    CBox_InputDeviceList.SelectedIndex = 0;
                }
            }
            CBox_InputDeviceList.EndUpdate();
        }

        private void InitializeInputSamplingRate()
        {
            var items = new [] {
                8000,
                11025,
                22050,
                44100,
            };

            CBox_InputSamplingRate.BeginUpdate();
            {
                foreach (var item in items) {
                    CBox_InputSamplingRate.Items.Add((uint)item);
                }
                CBox_InputSamplingRate.SelectedIndex = 0;
            }
            CBox_InputSamplingRate.EndUpdate();
        }

        private void InitializeInputBitsPerSample()
        {
            var items = new [] {
                8,
                16,
            };

            CBox_InputBitsPerSample.BeginUpdate();
            {
                foreach (var item in items) {
                    CBox_InputBitsPerSample.Items.Add((uint)item);
                }
                CBox_InputBitsPerSample.SelectedIndex = 0;
            }
            CBox_InputBitsPerSample.EndUpdate();
        }

        private void InitializeInputChannelNum()
        {
            CBox_InputChannelNum.BeginUpdate();
            {
                var item = CBox_InputDeviceList.SelectedItem as InputDeviceListItem;

                CBox_InputChannelNum.Items.Clear();
                if (item != null) {
                    for (var num = 1; num <= item.Value.Channels; num++) {
                        CBox_InputChannelNum.Items.Add(num);
                    }
                    CBox_InputChannelNum.SelectedIndex = 0;
                }
            }
            CBox_InputChannelNum.EndUpdate();
        }

        private void InitializeOutputDeviceList()
        {
            CBox_OutputDeviceList.BeginUpdate();
            {
                foreach (var dev in new MMDeviceEnumerator().EnumerateAudioEndPoints(DataFlow.Render, DeviceState.Active)) {
                    CBox_OutputDeviceList.Items.Add(new OutputDeviceListItem(dev));
                }
                if (CBox_OutputDeviceList.Items.Count > 0) {
                    CBox_OutputDeviceList.SelectedIndex = 0;
                }
            }
            CBox_OutputDeviceList.EndUpdate();
        }

        public override void Flush()
        {
            devp_.InputEnable.Value = ChkBox_InputEnable.Checked;
            try {
                devp_.InputDeviceId.Value = (CBox_InputDeviceList.SelectedItem as InputDeviceListItem).Value.NameGuid.ToString();
            } catch {
                devp_.InputDeviceId.Value = "";
            }
            devp_.InputSamplingRate.Value = uint.Parse(CBox_InputSamplingRate.Text);
            devp_.InputBitsPerSample.Value = uint.Parse(CBox_InputBitsPerSample.Text);
            devp_.InputChannelNum.Value = uint.Parse(CBox_InputChannelNum.Text);

            devp_.OutputEnable.Value = ChkBox_OutputEnable.Checked;
            try {
                devp_.OutputDeviceId.Value = (CBox_OutputDeviceList.SelectedItem as OutputDeviceListItem).Value.ID;
            } catch {
                devp_.OutputDeviceId.Value = "";
            }
        }
    }
}
